---
title: "mixture"
author: "Chris Cox"
date: "2025-11-28"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
# Source functions
source(here("functions.R"))
```

# Coupled Oscillator Model

```{r, eval = FALSE}
f_coupled_dynamics_acc <- mvbf(
    # Valence position
    FatherValence_s ~ 0 + Leave + (Leave | CoupleID),
    MotherValence_s ~ 0 + Leave + (Leave | CoupleID),
    
    # Arousal position
    FatherArousal_s ~ 0 + Leave + (Leave | CoupleID),
    MotherArousal_s ~ 0 + Leave + (Leave | CoupleID),
    
    # Velocity equations without coupling
    FatherValenceVel ~ 0 + Leave + (Leave | CoupleID),
    MotherValenceVel ~ 0 + Leave + (Leave | CoupleID),
    
    # Acceleration equations with coupling
    FatherValenceAcc ~ 0 + Leave +
                       Leave:FatherValence_s + Leave:FatherValenceVel +
                       Leave:MotherValence_s:isProximate + Leave:MotherValenceVel:isProximate +
                       Leave:FatherValence_s:FatherArousal_s + Leave:FatherValenceVel:FatherArousal_s +
                       Leave:MotherValence_s:isProximate:MotherArousal_s + Leave:MotherValenceVel:isProximate:MotherArousal_s +
                      (Leave:FatherValence_s + Leave:FatherValenceVel + Leave:MotherValence_s:isProximate + Leave:MotherValenceVel:isProximate + Leave:FatherValence_s:FatherArousal_s + Leave:FatherValenceVel:FatherArousal_s + Leave:MotherValence_s:isProximate:MotherArousal_s + Leave:MotherValenceVel:isProximate:MotherArousal_s | CoupleID),
    
    MotherValenceAcc ~ 0 + Leave +
                       Leave:MotherValence_s + Leave:MotherValenceVel +
                       Leave:FatherValence_s:isProximate + Leave:FatherValenceVel:isProximate +
                       Leave:MotherValence_s:MotherArousal_s + Leave:MotherValenceVel:MotherArousal_s +
                       Leave:FatherValence_s:isProximate:FatherArousal_s + Leave:FatherValenceVel:isProximate:FatherArousal_s +
                      (Leave:MotherValence_s + Leave:MotherValenceVel + Leave:FatherValence_s:isProximate + Leave:FatherValenceVel:isProximate + Leave:MotherValence_s:MotherArousal_s + Leave:MotherValenceVel:MotherArousal_s + Leave:FatherValence_s:isProximate:FatherArousal_s + Leave:FatherValenceVel:isProximate:FatherArousal_s | CoupleID))

p_coupled_dynamics <- c(
  prior(normal(0, 2), class = "b", resp = "FatherValenceAcc"),
  prior(normal(0, 2), class = "b", resp = "FatherValences"),
  prior(normal(0, 2), class = "b", resp = "FatherValenceVel"),
  prior(normal(0, 2), class = "b", resp = "MotherValenceAcc"),
  prior(normal(0, 2), class = "b", resp = "MotherValences"),
  prior(normal(0, 2), class = "b", resp = "MotherValenceVel"),
  prior(normal(1, 2), class = "sd", resp = "FatherValenceAcc"),
  prior(normal(1, 2), class = "sd", resp = "FatherValences"),
  prior(normal(1, 2), class = "sd", resp = "FatherValenceVel"),
  prior(normal(1, 2), class = "sd", resp = "MotherValenceAcc"),
  prior(normal(1, 2), class = "sd", resp = "MotherValences"),
  prior(normal(1, 2), class = "sd", resp = "MotherValenceVel"),
  prior(normal(1, 2), class = "sigma", resp = "FatherValenceAcc"),
  prior(normal(1, 2), class = "sigma", resp = "FatherValences"),
  prior(normal(1, 2), class = "sigma", resp = "FatherValenceVel"),
  prior(normal(1, 2), class = "sigma", resp = "MotherValenceAcc"),
  prior(normal(1, 2), class = "sigma", resp = "MotherValences"),
  prior(normal(1, 2), class = "sigma", resp = "MotherValenceVel"),
  prior(lkj(2), class = "rescor")
)

CoupledOscillatorModel <- brm(
            f_coupled_dynamics_acc,
            data = d_multivariate,
            family = gaussian(),
            prior = p_coupled_dynamics, 
            sample_prior = "yes",
            chains = 4,
            cores = 64,
            warmup = 500,
            iter = 5000,
            control = list(adapt_delta = 0.90, max_treedepth = 10),
            backend = 'cmdstan')
```

# Extract Data for the Paper

```{r}
#CoupledOscillatorModel <- readRDS(here("FinalModels", "CoupledOscillatorModel.rds"))
all_tests <- extract_all_tests(CoupledOscillatorModel)
#write.csv(all_tests, here("StatsForBodyText", "coupledoscillator_tests.csv"), row.names = FALSE)
```

# Figure 4A: Residual Valence Synchrony Plot
```{r}
# Extract correlations for when partners are proximate:
correlation_by_leave <- calculate_residual_correlations(
  model = CoupledOscillatorModel,
  mother_resp = "MotherValences",
  father_resp = "FatherValences",
  mother_var = "MotherValence_s",
  father_var = "FatherValence_s"
)

correlation_by_leave_arousal <- calculate_residual_correlations(
  model = CoupledOscillatorModel,
  mother_resp = "MotherArousals",
  father_resp = "FatherArousals",
  mother_var = "MotherArousal_s",
  father_var = "FatherArousal_s"
)

valence_cor <- correlation_by_leave %>%
  rename("Estimate" = median_r,
         "CI.Lower" = lower_95,
         "CI.Upper" = upper_95,
         "Evid.Ratio" = evidence_ratio_positive) %>%
  select(-prob_positive, -prob_negative) %>%
  mutate(Estimate = round(Estimate, 2),
         CI.Lower = round(CI.Lower, 2),
         CI.Upper = round(CI.Upper, 2),
         Evid.Ratio = round(Evid.Ratio, 2)) %>%
  mutate(TestDescription = c("T1_val_cor", "T2_val_cor"))

arousal_cor <- correlation_by_leave_arousal %>%
  rename("Estimate" = median_r,
         "CI.Lower" = lower_95,
         "CI.Upper" = upper_95,
         "Evid.Ratio" = evidence_ratio_positive) %>%
  select(-prob_positive, -prob_negative) %>%
  mutate(Estimate = round(Estimate, 2),
         CI.Lower = round(CI.Lower, 2),
         CI.Upper = round(CI.Upper, 2),
         Evid.Ratio = round(Evid.Ratio, 2)) %>%
  mutate(TestDescription = c("T1_aro_cor", "T2_aro_cor"))

cor_proximate <- rbind(valence_cor, arousal_cor)
#write.csv(cor_proximate, here("StatsForBodyText", "correlation_tests.csv"))

# Get FITTED values (predictions) for each response
fitted_father_val <- fitted(CoupledOscillatorModel, resp = "FatherValences", summary = TRUE)[, "Estimate"]
fitted_mother_val <- fitted(CoupledOscillatorModel, resp = "MotherValences", summary = TRUE)[, "Estimate"]

# Get OBSERVED values
observed_father_val <- CoupledOscillatorModel$data$FatherValence_s
observed_mother_val <- CoupledOscillatorModel$data$MotherValence_s

# Calculate RESIDUALS (observed - fitted)
father_resid <- observed_father_val - fitted_father_val
mother_resid <- observed_mother_val - fitted_mother_val

d_multivariate_Time <- d_multivariate %>%
  filter(!is.na(FatherArousal_s)) %>%
  filter(!is.na(FatherValence_s)) %>%
  filter(!is.na(MotherArousal_s)) %>%
  filter(!is.na(MotherValence_s)) %>%
  filter(!is.na(FatherValenceVel)) %>%
  filter(!is.na(MotherValenceVel)) %>%
  filter(!is.na(FatherValenceAcc)) %>%  
  filter(!is.na(MotherValenceAcc)) %>%
  filter(!is.na(isProximate))
  
# Create dataframe
resid_df <- data.frame(
  FatherValence_resid = father_resid,
  MotherValence_resid = mother_resid,
  CoupleID = CoupledOscillatorModel$data$CoupleID,
  Leave = CoupledOscillatorModel$data$Leave,
  Time = d_multivariate_Time$time
) %>%
  mutate(
    Time = ifelse(Leave == "Paternity Leave", Time + 42, Time)
  )

# Create subtitle with credible interval
subtitle_text_mat <- sprintf("r = %.2f [%.2f, %.2f]", 
                        correlation_by_leave$median_r[1],
                        correlation_by_leave$lower_95[1],
                        correlation_by_leave$upper_95[1])

subtitle_text_pat <- sprintf("r = %.2f [%.2f, %.2f]", 
                        correlation_by_leave$median_r[2],
                        correlation_by_leave$lower_95[2],
                        correlation_by_leave$upper_95[2])

# Create a data frame with annotation text for each leave period
annotation_text <- data.frame(
  Leave = c("Maternity Leave", "Paternity Leave"),
  label = c(
    sprintf("r = %.2f [%.2f, %.2f]", 
            correlation_by_leave$median_r[correlation_by_leave$Leave == "Maternity Leave"],
            correlation_by_leave$lower_95[correlation_by_leave$Leave == "Maternity Leave"],
            correlation_by_leave$upper_95[correlation_by_leave$Leave == "Maternity Leave"]),
    sprintf("r = %.2f [%.2f, %.2f]", 
            correlation_by_leave$median_r[correlation_by_leave$Leave == "Paternity Leave"],
            correlation_by_leave$lower_95[correlation_by_leave$Leave == "Paternity Leave"],
            correlation_by_leave$upper_95[correlation_by_leave$Leave == "Paternity Leave"])
  ),
  # Position for text - adjust x and y as needed
  x = c(21, 63),
  y = c(3.05, 3.05) 
)

# Create annotation for EACH couple (one for maternity side, one for paternity side)
annotation_text <- expand.grid(
  Couple = c("Couple A"),
  Leave = c("Maternity Leave", "Paternity Leave"),
  stringsAsFactors = FALSE
) %>%
  mutate(
    label = ifelse(Leave == "Maternity Leave",
                   sprintf("r = %.2f [%.2f, %.2f]", 
                           correlation_by_leave$median_r[correlation_by_leave$Leave == "Maternity Leave"],
                           correlation_by_leave$lower_95[correlation_by_leave$Leave == "Maternity Leave"],
                           correlation_by_leave$upper_95[correlation_by_leave$Leave == "Maternity Leave"]),
                   sprintf("r = %.2f [%.2f, %.2f]", 
                           correlation_by_leave$median_r[correlation_by_leave$Leave == "Paternity Leave"],
                           correlation_by_leave$lower_95[correlation_by_leave$Leave == "Paternity Leave"],
                           correlation_by_leave$upper_95[correlation_by_leave$Leave == "Paternity Leave"])),
    x = ifelse(Leave == "Maternity Leave", 21, 63),
    y = 3.0  # Adjust vertical position as needed
  )

# Create annotation data for only Couple A
annotation_df <- data.frame(
  x = c(21, 63),
  y = c(3, 3),
  label = c("Maternity Leave", "Paternity Leave"),
  Couple = c("Couple A", "Couple A")
)

# Prepare data with continuous time and transition points
couples_continuous <- bind_rows(
  resid_df %>% filter(CoupleID == "47"),
  resid_df %>% filter(CoupleID == "2"),
  resid_df %>% filter(CoupleID == "30")
) %>%
  group_by(CoupleID) %>%
  arrange(CoupleID, Leave) %>%
  mutate(
    time = row_number(),
    Couple = case_when(
      CoupleID == "47" ~ "Couple A",
      CoupleID == "2" ~ "Couple B",
      CoupleID == "30" ~ "Couple C"
    )
  ) %>%
  ungroup()

# Find where paternity leave starts for each couple
transition_points <- couples_continuous %>%
  group_by(Couple) %>%
  arrange(time) %>%
  mutate(leave_change = Leave != lag(Leave, default = first(Leave))) %>%
  filter(leave_change == TRUE, Leave == "Paternity Leave") %>%
  summarise(transition_time = first(time))

# Pivot for plotting
plot_data <- couples_continuous %>%
  pivot_longer(cols = c(FatherValence_resid, MotherValence_resid),
               names_to = "Parent",
               values_to = "Residual") %>%
  mutate(Parent = ifelse(Parent == "FatherValence_resid", "Father", "Mother"))

# Plot
ResidualCorPlot <- ggplot(plot_data, aes(x = Time, y = Residual, color = Parent)) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.3) +
  geom_vline(aes(xintercept = 42), 
             linetype = "dashed", color = "black", linewidth = 0.8, alpha = 0.8) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_y_continuous(breaks = c(-2, 0, 2), limits = c(-3.2, 3)) +
  scale_x_continuous(limits = c(0, 84), breaks = c(seq(0, 84, 10))) +
  facet_wrap(~Couple, ncol = 1, scales = "fixed") +
  scale_color_manual(values = c("Father" = "#fca636", "Mother" = "#446455")) +
  labs(
    y = "Valence Residual (z-score)",
    x = "Experience Sampling Prompt Number",
    color = NULL
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 20, face = "bold", color = "black"), 
    plot.subtitle = element_text(size = 15, hjust = 0.5, color = "black"),
    axis.text.x = element_text(size = 15, color = "black"),
    axis.text.y = element_text(size = 15, color = "black"),
    axis.title.x = element_text(size = 15, color = "black"),
    axis.title.y = element_text(size = 15, color = "black"),
    legend.title = element_blank(),
    legend.position = c(0.8, 0.65),
    legend.key.size = unit(1, "lines"),
    legend.text = element_text(size = 15),
    legend.background = element_rect(fill = "transparent", color = NA),
    legend.key = element_rect(fill = "transparent", color = NA),
    strip.background = element_rect(color = "white", fill = "white", linewidth = 1.5, linetype = "solid"),
    strip.text.x = element_text(size = 15, color = "black"),
    strip.text.y = element_text(size = 15, color = "black"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.border = element_blank(),
    strip.placement = "outside",
    panel.spacing = unit(0.2, "cm"),
    plot.margin = margin(t = 0.1, r = 0.1, b = 0.1, l = 0.1, unit = "cm"))

ResidualCorPlot

title <- ggdraw() + 
  draw_label("A) Residual Valence Synchrony",
             fontface = "bold", size = 20)

# Row 1: Maternity Leave / Paternity Leave labels
title1 <- ggdraw() + 
  draw_label(annotation_df$label[1], 
             fontface = "bold", size = 15, x = 0.25, hjust = 0.5) +
  draw_label(annotation_df$label[2], 
             fontface = "bold", size = 15, x = 0.75, hjust = 0.5)

# Row 2: Correlation values
title2 <- ggdraw() + 
  draw_label(annotation_text[1,]$label, size = 13, x = 0.25, hjust = 0.5) +
  draw_label(annotation_text[2,]$label, 
             size = 13, x = 0.75, hjust = 0.5)

fig4A_w_title <- plot_grid(title, title1, title2, ResidualCorPlot, 
                        ncol = 1, 
                        rel_heights = c(0.05, 0.05, 0.05, 1))

fig4A_w_title
```

# Figure 4B: Population-Level Arousal Dependence Plot

```{r}
pop_posteriors <- as.data.frame(CoupledOscillatorModel)

# ===== MATERNITY LEAVE =====

# Father → Mother (Maternity Leave)
f_to_m_base <- pop_posteriors %>%
  select(matches("^b_MotherValenceAcc_LeaveMaternityLeave:FatherValence_s:isProximate$")) %>%
  rename(value = 1) %>%
  mutate(effect = "Base Coupling", direction = "Father → Mother")

f_to_m_arousal <- pop_posteriors %>%
  select(matches("^b_MotherValenceAcc_LeaveMaternityLeave:FatherValence_s:isProximate:FatherArousal_s$")) %>%
  rename(value = 1) %>%
  mutate(effect = "Arousal Modulation", direction = "Father → Mother")

# Mother → Father (Maternity Leave)
m_to_f_base <- pop_posteriors %>%
  select(matches("^b_FatherValenceAcc_LeaveMaternityLeave:MotherValence_s:isProximate$")) %>%
  rename(value = 1) %>%
  mutate(effect = "Base Coupling", direction = "Mother → Father")

m_to_f_arousal <- pop_posteriors %>%
  select(matches("^b_FatherValenceAcc_LeaveMaternityLeave:MotherValence_s:isProximate:MotherArousal_s$")) %>%
  rename(value = 1) %>%
  mutate(effect = "Arousal Modulation", direction = "Mother → Father")

# Combine all data
pop_data <- bind_rows(f_to_m_base, f_to_m_arousal, m_to_f_base, m_to_f_arousal)

# Calculate coupling at different arousal levels
pop_data_revised <- bind_rows(
  # Father → Mother at different arousal levels
  pop_posteriors %>%
    select(base = matches("^b_MotherValenceAcc_LeaveMaternityLeave:FatherValence_s:isProximate$"),
           arousal_mod = matches("^b_MotherValenceAcc_LeaveMaternityLeave:FatherValence_s:isProximate:FatherArousal_s$")) %>%
    mutate(
      high_arousal = base + arousal_mod,
      mean_arousal = base,
      low_arousal = base - arousal_mod
    ) %>%
    select(-base, -arousal_mod) %>%
    pivot_longer(everything(), names_to = "arousal_level", values_to = "value") %>%
    mutate(direction = "Father → Mother"),
  
  # Mother → Father at different arousal levels
  pop_posteriors %>%
    select(base = matches("^b_FatherValenceAcc_LeaveMaternityLeave:MotherValence_s:isProximate$"),
           arousal_mod = matches("^b_FatherValenceAcc_LeaveMaternityLeave:MotherValence_s:isProximate:MotherArousal_s$")) %>%
    mutate(
      high_arousal = base + arousal_mod,
      mean_arousal = base,
      low_arousal = base - arousal_mod
    ) %>%
    select(-base, -arousal_mod) %>%
    pivot_longer(everything(), names_to = "arousal_level", values_to = "value") %>%
    mutate(direction = "Mother → Father")
)

# Clean up labels
pop_data_revised <- pop_data_revised %>%
  mutate(arousal_level = factor(arousal_level,
                                levels = c("low_arousal", "mean_arousal", "high_arousal"),
                                labels = c("Low Arousal (-1 SD)", "Mean Arousal", "High Arousal (+1 SD)"))) %>%
  mutate(direction = factor(direction, levels = c("Mother → Father", "Father → Mother")))

# Calculate medians
pop_summary_revised <- pop_data_revised %>%
  group_by(direction, arousal_level) %>%
  summarise(median = median(value), .groups = "drop")

# ===== PATERNITY LEAVE =====

# Extract population posteriors for Paternity Leave
pop_posteriors <- as.data.frame(CoupledOscillatorModel)

# Calculate coupling at different arousal levels - PATERNITY LEAVE
pop_data_revised_pat <- bind_rows(
  # Father → Mother at different arousal levels
  pop_posteriors %>%
    select(base = matches("^b_MotherValenceAcc_LeavePaternityLeave:FatherValence_s:isProximate$"),
           arousal_mod = matches("^b_MotherValenceAcc_LeavePaternityLeave:FatherValence_s:isProximate:FatherArousal_s$")) %>%
    mutate(
      high_arousal = base + arousal_mod,
      mean_arousal = base,
      low_arousal = base - arousal_mod
    ) %>%
    select(-base, -arousal_mod) %>%
    pivot_longer(everything(), names_to = "arousal_level", values_to = "value") %>%
    mutate(direction = "Father → Mother"),
  
  # Mother → Father at different arousal levels
  pop_posteriors %>%
    select(base = matches("^b_FatherValenceAcc_LeavePaternityLeave:MotherValence_s:isProximate$"),
           arousal_mod = matches("^b_FatherValenceAcc_LeavePaternityLeave:MotherValence_s:isProximate:MotherArousal_s$")) %>%
    mutate(
      high_arousal = base + arousal_mod,
      mean_arousal = base,
      low_arousal = base - arousal_mod
    ) %>%
    select(-base, -arousal_mod) %>%
    pivot_longer(everything(), names_to = "arousal_level", values_to = "value") %>%
    mutate(direction = "Mother → Father")
)

# Clean up labels
pop_data_revised_pat <- pop_data_revised_pat %>%
  mutate(
    arousal_level = factor(arousal_level,
                          levels = c("low_arousal", "mean_arousal", "high_arousal"),
                          labels = c("Low Arousal (-1 SD)", "Mean Arousal", "High Arousal (+1 SD)")),
    direction = factor(direction, levels = c("Mother → Father", "Father → Mother")),
    leave_type = "Paternity Leave"
  )

# Calculate medians for paternity
pop_summary_revised_pat <- pop_data_revised_pat %>%
  group_by(direction, arousal_level) %>%
  summarise(median = median(value), .groups = "drop")

# Add leave_type column to both datasets
combined_data <- bind_rows(
  pop_data_revised %>% mutate(leave_type = "Maternity Leave"),
  pop_data_revised_pat %>% mutate(leave_type = "Paternity Leave")
)

# Make plot
fig4B <- ggplot(combined_data, aes(x = value, y = arousal_level, color = direction, fill = direction)) +
  stat_dots(aes(color = direction, fill = direction), scale = 0.8, quantiles = 150, dotsize = 1, alpha = 1, side = "top", show.legend = c(fill = T, color = F, size = FALSE, alpha = FALSE)) +
  stat_pointinterval(aes(x = value, y = as.numeric(arousal_level) - 0.07, point_fill = direction, color = direction), .width = c(0.5, 0.89), point_interval = "median_qi", position = position_dodge(width = 0.1), show.legend = FALSE) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", linewidth = 0.5) +
  facet_wrap(~leave_type, ncol = 2, scale = "fixed") +
  scale_fill_manual(values = c("Mother → Father" = "#fca636", "Father → Mother" = "#446455"),
                    labels = c("Mother → Father" = "Father", "Father → Mother" = "Mother")) +
  scale_color_manual(values = c("Mother → Father" = "#fca636", "Father → Mother" = "#446455"),
                     labels = c("Mother → Father" = "Father", "Father → Mother" = "Mother")) +
  labs(x = "Coupling Strength (Standardized)", y = NULL) +
  scale_y_discrete(expand = expansion(add = c(0.2, 0.9))) +
  guides(
  fill = guide_legend(
    title = NULL,
    override.aes = list(
      size = 2, 
      linewidth = 5, 
      alpha = 1,
      color = c("#fca636", "#446455")
    )
  )) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 20, face = "bold", color = "black"), 
    plot.subtitle = element_text(size = 12, hjust = 0.5, color = "black"),
    axis.text.x = element_text(size = 15, color = "black"),
    axis.text.y = element_text(size = 15, color = "black"),
    axis.title.x = element_text(size = 15, color = "black"),
    axis.title.y = element_text(size = 15, color = "black"),
    legend.title = element_blank(),
    legend.position = c(0.5, 0.3),
    legend.key.size = unit(1, "lines"),
    legend.text = element_text(size = 15),
    legend.background = element_rect(fill = "transparent", color = NA),
    legend.key = element_rect(fill = "transparent", color = NA),
    strip.background = element_rect(color = "white", fill = "white", linewidth = 1.5, linetype = "solid"),
    strip.text.x = element_text(size = 15, color = "black"),
    strip.text.y = element_text(size = 15, color = "black"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.border = element_blank(),
    strip.placement = "outside",
    panel.spacing = unit(1, "cm"),
    plot.margin = margin(t = 0.1, r = 0.1, b = 0.1, l = 0.1, unit = "cm"))

fig4B

title <- ggdraw() + 
  draw_label("B) Population-Level Arousal Dependence",
             fontface = "bold", size = 20)
fig4B_w_title <- plot_grid(title, fig4B, ncol = 1, rel_heights = c(0.05, 1))
```

# Figure 4C: State-Dependent Emotion Coupling, Father
```{r}
# Create grid
create_grid_for_couple <- function(couple_id, grid_size) {
  expand_grid(
    CoupleID = couple_id,
    MotherValence_s = seq(-2, 2, length.out = grid_size),
    MotherArousal_s = seq(-2, 2, length.out = grid_size),
    FatherValenceVel = 0,
    MotherValenceVel = 0,
    isProximate = 1,
    FatherValence_s = 0,
    FatherArousal_s = 0,
    Leave = c("Paternity Leave", "Maternity Leave")
  )
}

grid <- create_grid_for_couple(
  couple_id = unique(CoupledOscillatorModel$data$CoupleID)[1:40],
  grid_size = 40
)

# Get predictions
predictions <- predict(CoupledOscillatorModel, newdata = grid, 
                      allow_new_levels = TRUE, ndraws = 500, resp = "FatherValenceAcc")

pred_data <- as.data.frame(predictions) %>%
  mutate(CoupleID = grid$CoupleID,
         MotherValence_s = grid$MotherValence_s,
         MotherArousal_s = grid$MotherArousal_s,
         Leave = grid$Leave)

# Calculate mean transitions
bin_size <- 0.1

mean_transitions <- pred_data %>%
  mutate(
    ValenceBin = round(MotherValence_s / bin_size) * bin_size,
    ArousalBin = round(MotherArousal_s / bin_size) * bin_size
  ) %>%
  group_by(ValenceBin, ArousalBin, Leave) %>%
  summarize(
    mean_change = mean(Estimate),
    se_change = sd(Estimate) / sqrt(n()),
    .groups = "drop"
  )

# Simplified plot function (no consistency tiles)
create_heatmap_plot <- function(mean_transitions, leave_type, 
                                with_y_axis = FALSE, show_legend = FALSE) {
  
  y_axis <- if(with_y_axis) {
    element_text(size = 15, color = "black")
  } else {
    element_blank()
  }
  
  legend_pos <- if(show_legend) "bottom" else "none"
  
  ggplot(mean_transitions %>% filter(Leave == leave_type)) +
    geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.3) +
    geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.3) +
    geom_tile(aes(x = ArousalBin, y = ValenceBin, fill = mean_change), 
              alpha = 0.99) +
    scale_fill_gradient2(
      low = "#d8434e", mid = "#f0f0f0", high = "#018571",
      midpoint = 0, 
      breaks = c(-0.5, 0, 0.5),
      name = "Father\nAcceleration"
    ) +
    scale_x_continuous(breaks = seq(-2, 2, 1)) +
    scale_y_continuous(breaks = seq(-2, 2, 1)) +
    labs(
      title = leave_type,
      x = NULL,
      y = if(with_y_axis) "Mother Valence (z-score)" else NULL
    ) +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5, size=20), 
        axis.text.x = element_text(size = 20, color = "black"),
        axis.title.x = element_text(size = 20, color = "black"),
        axis.text.y = if(with_y_axis) element_text(size = 20, color = "black") else element_blank(),
        axis.title.y = element_text(size = 17, color = "black"),
        legend.title = element_text(size = 17, color = "black"),
        legend.position = if(show_legend) "right" else "none",
        legend.key.size = unit(1.5, "lines"),
        legend.text = element_text(size = 17, hjust = 1),
        legend.background = element_rect(fill = "transparent", color = NA),
        legend.key = element_rect(fill = "transparent", color = NA),
        strip.background = element_rect(color="white", fill="white", linewidth=1.5, linetype="solid"),
        strip.text.x = element_text(size = 25, color = "black"),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank(),
        plot.margin = margin(t = 0.1, r = 0.1, b = 0.9, l = 0.1, unit = "cm")
        )
}

# Create plots
heatmap_mat <- create_heatmap_plot(mean_transitions, "Maternity Leave", 
                                   with_y_axis = TRUE, show_legend = FALSE)
heatmap_pat <- create_heatmap_plot(mean_transitions, "Paternity Leave", 
                                   with_y_axis = FALSE, show_legend = TRUE)

# Combine
fig_heatmap <- plot_grid(heatmap_mat, NULL, heatmap_pat, 
                         ncol = 3, rel_widths = c(1.1, 0.1, 1.45),
                         align = "h")

# Add centered x-axis label
fig1 <- ggdraw(clip = "off") +
  draw_plot(fig_heatmap) +
  draw_text(
    "Mother Arousal (z-score)",
    x = 0.5,          
    y = 0.02,         
    hjust = 0.5,      
    vjust = 0,        
    size = 17
  )

print(fig1)
```

# Figure 4C: State-Dependent Emotion Coupling, Mother
```{r}
# Create grid (now for Father's states)
create_grid_for_couple <- function(couple_id, grid_size) {
  expand_grid(
    CoupleID = couple_id,
    FatherValence_s = seq(-2, 2, length.out = grid_size),
    FatherArousal_s = seq(-2, 2, length.out = grid_size),
    MotherValenceVel = 0,
    FatherValenceVel = 0,
    isProximate = 1,
    MotherValence_s = 0,
    MotherArousal_s = 0,
    Leave = c("Paternity Leave", "Maternity Leave")
  )
}

grid <- create_grid_for_couple(
  couple_id = unique(CoupledOscillatorModel$data$CoupleID)[1:40],
  grid_size = 40
)

# Get predictions for MOTHER acceleration
predictions <- predict(CoupledOscillatorModel, newdata = grid, 
                      allow_new_levels = TRUE, ndraws = 500, resp = "MotherValenceAcc")

pred_data <- as.data.frame(predictions) %>%
  mutate(CoupleID = grid$CoupleID,
         FatherValence_s = grid$FatherValence_s,
         FatherArousal_s = grid$FatherArousal_s,
         Leave = grid$Leave)

# Calculate mean transitions
bin_size <- 0.1

mean_transitions <- pred_data %>%
  mutate(
    ValenceBin = round(FatherValence_s / bin_size) * bin_size,
    ArousalBin = round(FatherArousal_s / bin_size) * bin_size
  ) %>%
  group_by(ValenceBin, ArousalBin, Leave) %>%
  summarize(
    mean_change = mean(Estimate),
    se_change = sd(Estimate) / sqrt(n()),
    .groups = "drop"
  )

# Plot function
create_heatmap_plot_mother <- function(mean_transitions, leave_type, 
                                       with_y_axis = FALSE, show_legend = FALSE) {
  
  y_axis <- if(with_y_axis) {
    element_text(size = 15, color = "black")
  } else {
    element_blank()
  }
  
  legend_pos <- if(show_legend) "bottom" else "none"
  
  ggplot(mean_transitions %>% filter(Leave == leave_type)) +
    geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.3) +
    geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.3) +
    geom_tile(aes(x = ArousalBin, y = ValenceBin, fill = mean_change), 
              alpha = 0.99) +
    scale_fill_gradient2(
      low = "#0d0887", mid = "#f0f0f0", high = "#E1AF00",
      midpoint = 0, 
      limits = c(-0.7, 0.8),
      breaks = c(-0.5, 0, 0.5),
      name = "Mother\nAcceleration"
    ) +
    scale_x_continuous(breaks = seq(-2, 2, 1)) +
    scale_y_continuous(breaks = seq(-2, 2, 1)) +
    labs(
      title = leave_type,
      x = NULL,
      y = if(with_y_axis) expression(paste("Father Valence (", italic("z"), "-score)")) else NULL
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5, size = 20), 
      axis.text.x = element_text(size = 20, color = "black"),
      axis.title.x = element_text(size = 20, color = "black"),
      axis.text.y = if(with_y_axis) element_text(size = 20, color = "black") else element_blank(),
      axis.title.y = element_text(size = 17, color = "black"),
      legend.title = element_text(size = 17, color = "black"),
      legend.position = if(show_legend) "right" else "none",
      legend.key.size = unit(1.5, "lines"),
      legend.text = element_text(size = 17, hjust = 1),
      legend.background = element_rect(fill = "transparent", color = NA),
      legend.key = element_rect(fill = "transparent", color = NA),
      strip.background = element_rect(color = "white", fill = "white", linewidth = 1.5, linetype = "solid"),
      strip.text.x = element_text(size = 25, color = "black"),
      panel.grid.minor = element_blank(),
      panel.grid.major = element_blank(),
      plot.margin = margin(t = 0.1, r = 0.1, b = 0.9, l = 0.1, unit = "cm")
    )
}

# Create plots
heatmap_mat_mother <- create_heatmap_plot_mother(mean_transitions, "Maternity Leave", 
                                                  with_y_axis = TRUE, show_legend = FALSE)
heatmap_pat_mother <- create_heatmap_plot_mother(mean_transitions, "Paternity Leave", 
                                                  with_y_axis = FALSE, show_legend = TRUE)

# Combine
fig_heatmap_mother <- plot_grid(heatmap_mat_mother, NULL, heatmap_pat_mother, 
                                ncol = 3, rel_widths = c(1.1, 0.1, 1.45),
                                align = "h")

# Add centered x-axis label
fig_mother <- ggdraw(clip = "off") +
  draw_plot(fig_heatmap_mother) +
  draw_text(
    "Father Arousal (z-score)",
    x = 0.5,
    y = 0.02,
    hjust = 0.5,
    vjust = 0,
    size = 17
  )

print(fig_mother)

title <- ggdraw() + 
  draw_label("C) State-Dependent Emotion Coupling", 
             fontface = "bold", size = 20)

fig4C_w_title <- plot_grid(title, NULL, 
          plot_grid(fig_mother, NULL, fig1, nrow = 1, rel_widths = c(1, 0.1, 1)),
          ncol = 1, 
          rel_heights = c(0.09, 0.05, 1))
```

# Combine all Figures into Plot

```{r}
fig4A_and_B_w_title <- plot_grid(fig4A_w_title, NULL, fig4B_w_title, nrow = 1, rel_widths = c(1, 0.1, 1),
          align = 'v',
          axis = 'tb')

fig4full <- plot_grid(NULL, fig4A_and_B_w_title, NULL, fig4C_w_title, NULL,
          ncol = 1, 
          rel_heights = c(0.02, 0.8, 0.07, 0.3, 0.02))

#ggsave(plot = fig4full, file = here("FinalFigures", "FullPatternDescription.pdf"), height = 13, width = 15)
#ggsave(plot = fig4full, file = here("FinalFigures", "FullPatternDescription.png"), height = 13, width = 15)
```