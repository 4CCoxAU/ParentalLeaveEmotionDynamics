---
title: "preprocessing"
author: "Chris Cox"
date: "2025-11-28"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

# Pre-Processing Script

```{r, setup, include = FALSE}
knitr::opts_chunk$set(tidy = TRUE, tidy.opts = list(width.cutoff = 60))
```

```{r}
source(here("functions.R"))
```

## Preprocess the Maternity Leave Data
```{r}
T1_exclusion_reasons <- capture.output(
  d_T1_multivariate <- preprocess_ES_data(
    data_path = file.path("/work/Paternity-leave/01. BarselProject", 
                          "data/completed/BOTH/ESM/t1", 
                          "T1_ESM_Daytime_Preprocessed.csv"),
    scales = scales_T1,
    scales_full = scales_full_T1,
    time_threshold_minutes = 3,
    min_responses_per_day = 2)
)
```

## Preprocess the Paternity Leave Data

```{r}
T2_exclusion_reasons <- capture.output(
  d_T2_multivariate <- preprocess_ES_data(
    data_path = file.path("/work/Paternity-leave/01. BarselProject/",
                        "data/completed/BOTH/ESM/t2/",
                        "T2_ESM_Daytime_Preprocessed.csv"),
    scales = scales_T2,
    scales_full = scales_full_T2,
    time_threshold_minutes = 3, 
    min_responses_per_day = 2))
```

## Combine into one dataset for modelling purposes

```{r}
d_multivariate <- bind_rows(
  d_T1_multivariate %>% mutate(Leave = "Maternity Leave"),
  d_T2_multivariate %>% mutate(Leave = "Paternity Leave")) %>%
  group_by(CoupleID) %>%
  mutate(
    FatherValence_s = scale(FatherValence)[,1],
    FatherArousal_s = scale(FatherArousal)[,1],
    MotherValence_s = scale(MotherValence)[,1],
    MotherArousal_s = scale(MotherArousal)[,1]) %>%
  ungroup() %>%
  group_by(CoupleID, StudyDay) %>%
  arrange(CoupleID, time) %>%
    mutate(
      across(
        c(MotherArousal_s, MotherValence_s, 
          FatherArousal_s, FatherValence_s),
        list(
          Prev = ~lag(.),
          PrevPrev = ~lag(., 2),
          PrevPrevPrev = ~lag(., 3),
          PrevPrevPrevPrev = ~lag(., 4),
          PrevPrevPrevPrevPrev = ~lag(., 5)
        )
      )
    ) %>%
  arrange(CoupleID, Leave, time) %>%
  mutate(isProximate = if_else(DistanceDiff < 50, 1, 0)) %>%
  group_by(CoupleID, Leave) %>%
  arrange(CoupleID, Leave, time) %>%
  mutate(
    FatherValenceVel = (FatherValence_s - FatherValence_s_Prev),
    MotherValenceVel = (MotherValence_s - MotherValence_s_Prev),
    FatherValenceAcc = (FatherValence_s - 2*FatherValence_s_Prev + FatherValence_s_PrevPrev),
    MotherValenceAcc = (MotherValence_s - 2*MotherValence_s_Prev + MotherValence_s_PrevPrev)
  ) %>%
  ungroup()

overlappingleaveT2 <- read.csv(here("analysis_scripts", "dads_NOTon_leave_T2_CC.csv"))
overlappingleaveT2mothers <- read.csv(here("analysis_scripts", "moms_on_leave_T2_CC.csv"))

fathers_on_leave <- filter(overlappingleaveT2, is.na(Decision))
moms_on_leave <- filter(overlappingleaveT2mothers, Decision == "On Leave")

couples_w_overlapping_leave_periods <- unique(c(moms_on_leave$CoupleID, fathers_on_leave$CoupleID))
d_multivariate <- filter(d_multivariate, !CoupleID %in% couples_w_overlapping_leave_periods)

d_multivariate_close_proximity <- d_multivariate %>%
  mutate(DistanceCategory = ifelse(DistanceDiff < 50, "Close", "Far")) %>%
  filter(DistanceCategory == "Close")

d_multivariate_far_proximity <- d_multivariate %>%
  mutate(DistanceCategory = ifelse(DistanceDiff < 50, "Close", "Far")) %>%
  filter(DistanceCategory == "Far")

d_multivariate_close_proximity_T1 <- d_multivariate_close_proximity %>%
  filter(Leave == "Maternity Leave")

d_multivariate_close_proximity_T2 <- d_multivariate_close_proximity %>%
  filter(Leave == "Paternity Leave")

# Change preprocessing to allow acceleration to persist over days:
d_multivariate_no_dis <- d_multivariate %>%
  group_by(CoupleID) %>%
  arrange(CoupleID, time) %>%
    mutate(
      across(
        c(MotherArousal_s, MotherValence_s, 
          FatherArousal_s, FatherValence_s),
        list(
          Prev = ~lag(.),
          PrevPrev = ~lag(., 2),
          PrevPrevPrev = ~lag(., 3),
          PrevPrevPrevPrev = ~lag(., 4),
          PrevPrevPrevPrevPrev = ~lag(., 5)
        )
      )
    ) %>%
  group_by(CoupleID, Leave) %>%
  arrange(CoupleID, Leave, time) %>%
  mutate(
    FatherValenceVel = (FatherValence_s - FatherValence_s_Prev),
    MotherValenceVel = (MotherValence_s - MotherValence_s_Prev),
    FatherValenceAcc = (FatherValence_s - 2*FatherValence_s_Prev + FatherValence_s_PrevPrev),
    MotherValenceAcc = (MotherValence_s - 2*MotherValence_s_Prev + MotherValence_s_PrevPrev)
  ) %>%
  ungroup()
```
